---
import { Icon } from "astro-icon/components";
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";
import IconLinkTag from "./IconLinkTag.astro";

interface Props {
  entry: CollectionEntry<"publications">;
}

const { entry } = Astro.props;
const { title, authors, year, venue, links, cover, badges } = entry.data;

const iconMap: Record<string, string> = {
  pdf: "tabler:file-text",
  code: "simple-icons:github",
  demo: "tabler:player-play",
  slides: "tabler:slideshow",
  video: "tabler:video",
  website: "tabler:world",
};

const badgeStyles: Record<string, string> = {
  gold: "bg-gradient-to-r from-amber-50 to-yellow-50 text-amber-700 border-amber-200 shadow-sm",
  blue: "bg-blue-50 text-blue-700 border-blue-100",
  red: "bg-rose-50 text-rose-700 border-rose-100",
  green: "bg-emerald-50 text-emerald-700 border-emerald-100",
  default: "bg-gray-50 text-gray-700 border-gray-200",
};

// Helper to format link label (e.g., "pdf" -> "PDF")
const formatLabel = (key: string) => {
  if (key === "pdf") return "PDF";
  if (key === "github" || key === "code") return "Code";
  if (key === "website") return "Website";
  if (key === "slides") return "Slides";
  if (key === "video") return "Video";
  return key;
};
---

<div
  class="flex flex-col sm:flex-row gap-6 py-8 border-b border-gray-100 last:border-0 group"
>
  {
    cover && (
      <div class="shrink-0 w-full sm:w-48 h-32 sm:h-28 flex items-center justify-center">
        <button
          onclick={`document.getElementById('dialog-${entry.id}').showModal()`}
          class="cursor-zoom-in w-full h-full flex items-center justify-center focus:outline-none"
          aria-label="Enlarge cover image"
        >
          <Image
            src={cover}
            alt={title}
            class="max-w-full max-h-full w-auto h-auto rounded-lg border border-gray-100 bg-white group-hover:scale-105 transition-transform duration-500"
            quality={80}
            format="webp"
            width={300}
          />
        </button>

        <dialog
          id={`dialog-${entry.id}`}
          class="bg-transparent p-0 m-auto backdrop:bg-black/80 focus:outline-none max-w-[90vw] max-h-[90vh]"
          onclick="if(event.target === this) this.close()"
        >
          <div class="relative flex items-center justify-center">
            <Image
              src={cover}
              alt={title}
              class="max-w-full max-h-[90vh] w-auto h-auto rounded-lg shadow-2xl block"
              quality={100}
              format="webp"
              width={1200}
            />
            <button
              onclick={`document.getElementById('dialog-${entry.id}').close()`}
              class="absolute top-3 right-3 bg-white text-gray-900 rounded-full w-10 h-10 flex items-center justify-center shadow-sm border border-gray-200 hover:bg-gray-100 transition-colors focus:outline-none cursor-pointer"
              aria-label="Close"
            >
              <Icon name="tabler:x" class="w-5 h-5" />
            </button>
          </div>
        </dialog>
      </div>
    )
  }

  <div class="flex-grow space-y-2">
    <!-- Title -->
    <h3
      class="text-lg font-semibold text-gray-900 leading-tight group-hover:text-blue-600 transition-colors"
    >
      {
        links?.website ? (
          <a href={links.website} target="_blank">
            {title}
          </a>
        ) : links?.pdf ? (
          <a href={links.pdf} target="_blank">
            {title}
          </a>
        ) : (
          title
        )
      }
    </h3>

    <!-- Authors -->
    <div class="text-gray-600 text-sm leading-relaxed">
      {authors.join(", ")}
    </div>

    <!-- Venue & Year & Badges -->
    <div class="flex items-center flex-wrap gap-2 text-sm text-gray-500">
      <span class="font-medium text-gray-800">{venue}</span>
      <span>Â·</span>
      <span>{year}</span>

      {/* Badges */}
      {
        badges &&
          badges.map((badge) => (
            <span
              class={`px-2 py-0.5 rounded-full text-xs font-medium border flex items-center gap-1 ${badgeStyles[badge.type] || badgeStyles.default}`}
            >
              {badge.type === "gold" && <Icon name="tabler:sparkles" />}
              {badge.type === "red" && <Icon name="tabler:speakerphone" />}
              {badge.type === "blue" && <Icon name="tabler:flag" />}
              {badge.text}
            </span>
          ))
      }
    </div>

    <!-- Links -->
    {
      links && Object.keys(links).length > 0 && (
        <div class="flex flex-wrap gap-3 pt-1">
          {Object.entries(links).map(([key, url]) => {
            if (!url || url === "#") return null;
            const icon = iconMap[key] || "external-link";
            return (
              <IconLinkTag icon={icon} href={url}>
                {formatLabel(key)}
              </IconLinkTag>
            );
          })}
        </div>
      )
    }
  </div>
</div>
