---
import Layout from "../../layouts/Layout.astro";
import { getCollection, render } from "astro:content";
import { Icon } from "astro-icon/components";
import Prose from "../../components/Prose.astro";
import ThesisItem from "../../components/ThesisItem.astro";

export async function getStaticPaths() {
  const teamMembers = await getCollection("team");
  return teamMembers.map((member) => ({
    params: { slug: member.id.replace(/\.[^/.]+$/, "") },
    props: { member },
  }));
}

const { member } = Astro.props;
const { Content } = await render(member);
const {
  name,
  role,
  extra_affiliations,
  avatar,
  joinedIn,
  email,
  website,
  linkedin,
  github,
  twitter,
  googleScholar,
  phone,
} = member.data;

const memberId = member.id.replace(/\.[^/.]+$/, "");
const allTheses = await getCollection("theses");
const supervisedTheses = allTheses.filter((thesis) => 
  thesis.data.supervisors.includes(memberId)
).sort((a, b) => a.data.order - b.data.order);

const availableTheses = supervisedTheses.filter((t) => !t.data.assigned);
const assignedTheses = supervisedTheses.filter((t) => t.data.assigned);
---

<Layout title={name}>
  <div class="max-w-4xl mx-auto px-4 py-12 sm:py-20">
    <a
      href="/team"
      class="inline-flex items-center text-sm text-gray-500 hover:text-blue-600 mb-8 transition-colors"
    >
      <Icon name="tabler:arrow-left" class="w-4 h-4 mr-1" /> Back to Team
    </a>

    <div
      class="bg-white rounded-3xl p-8 border border-gray-100 shadow-sm mb-12"
    >
      <div class="flex flex-col md:flex-row gap-8 items-center">
        <div
          class="w-32 h-32 md:w-48 md:h-48 rounded-2xl overflow-hidden bg-gray-100 shrink-0 mx-auto md:mx-0"
        >
          <img src={avatar.src} alt={name} class="w-full h-full object-cover" />
        </div>

        <div class="flex-grow text-center md:text-left">
          <h2 class="mb-2">{name}</h2>
          <p class="text-xl text-blue-600 font-medium flex gap-2 items-center justify-center md:justify-start">
            {role}

            <!-- Extra affiliations -->
            {
              extra_affiliations.map((affiliation) => {
                return (
                  <span
                    class={`px-2 py-0.5 rounded-full  border gap-1 text-sm text-gray-500`}
                  >
                    {affiliation}
                  </span>
                );
              })
            }
          </p>

          <!-- Dates -->
          {joinedIn && <p class="text-sm text-gray-500 mb-2">Joined in {joinedIn}</p>}

          <!-- Links -->
          <div class="flex flex-wrap justify-center md:justify-start gap-3 mt-6">
            {
              email && (
                <a
                  href={`mailto:${email}`}
                  class="flex items-center gap-2 px-4 py-2 rounded-full bg-gray-50 text-gray-600 hover:bg-blue-50 hover:text-blue-600 transition-colors text-sm"
                >
                  <Icon name="tabler:mail" class="w-4 h-4" />
                  <span>Email</span>
                </a>
              )
            }
            {
              website && (
                <a
                  href={website}
                  target="_blank"
                  class="flex items-center gap-2 px-4 py-2 rounded-full bg-gray-50 text-gray-600 hover:bg-blue-50 hover:text-blue-600 transition-colors text-sm"
                >
                  <Icon name="tabler:world" class="w-4 h-4" />
                  <span>Website</span>
                </a>
              )
            }
            {
              linkedin && (
                <a
                  href={linkedin}
                  target="_blank"
                  class="flex items-center gap-2 px-4 py-2 rounded-full bg-gray-50 text-gray-600 hover:bg-blue-50 hover:text-blue-600 transition-colors text-sm"
                >
                  <Icon name="simple-icons:linkedin" class="w-4 h-4" />
                  <span>LinkedIn</span>
                </a>
              )
            }
            {
              github && (
                <a
                  href={github}
                  target="_blank"
                  class="flex items-center gap-2 px-4 py-2 rounded-full bg-gray-50 text-gray-600 hover:bg-blue-50 hover:text-blue-600 transition-colors text-sm"
                >
                  <Icon name="simple-icons:github" class="w-4 h-4" />
                  <span>GitHub</span>
                </a>
              )
            }
            {
              twitter && (
                <a
                  href={twitter}
                  target="_blank"
                  class="flex items-center gap-2 px-4 py-2 rounded-full bg-gray-50 text-gray-600 hover:bg-blue-50 hover:text-blue-600 transition-colors text-sm"
                >
                  <Icon name="simple-icons:twitter" class="w-4 h-4" />
                  <span>Twitter</span>
                </a>
              )
            }
            {
              googleScholar && (
                <a
                  href={googleScholar}
                  target="_blank"
                  class="flex items-center gap-2 px-4 py-2 rounded-full bg-gray-50 text-gray-600 hover:bg-blue-50 hover:text-blue-600 transition-colors text-sm"
                >
                  <Icon name="simple-icons:googlescholar" class="w-4 h-4" />
                  <span>Scholar</span>
                </a>
              )
            }
            {
              phone && (
                <a
                  href={'tel:' + phone}
                  target="_blank"
                  class="flex items-center gap-2 px-4 py-2 rounded-full bg-gray-50 text-gray-600 hover:bg-blue-50 hover:text-blue-600 transition-colors text-sm"
                >
                  <Icon name="tabler:phone" class="w-4 h-4" />
                  <span>{phone}</span>
                </a>
              )
            }
          </div>
        </div>
      </div>
    </div>

    <Prose><Content /></Prose>

    {availableTheses.length > 0 && (
      <div class="mt-12">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Available Theses</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          {availableTheses.map((thesis) => <ThesisItem entry={thesis} />)}
        </div>
      </div>
    )}

    {assignedTheses.length > 0 && (
      <div class="mt-12">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Assigned Theses</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          {assignedTheses.map((thesis) => <ThesisItem entry={thesis} />)}
        </div>
      </div>
    )}
  </div>
</Layout>
